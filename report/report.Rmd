---
title: "City Lifestyle Segmentation Report"
author: "Jiayi Xu"
output:
  pdf_document: default
  html_document:
    df_print: paged
    toc: true       
    toc_depth: 3    
    toc_float: true 
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggcorrplot)
library(plotly)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
```

# Introduction

This report analyzes the City Lifestyle Segmentation dataset to:
	1.	Identify lifestyle-based clusters of world cities using PCA and clustering.
	2.	Compare developed vs. developing regions.
	3.	Explore the relationship between economic and environmental factors.
	
# Load Data
```{r}
data_path <- "../data/city_lifestyle.csv"
city <- readr::read_csv(data_path)

# Quick summary
summary(city)
```

# Exploratory Data Analysis (EDA)

## Data check
```{r}
cat("Number of cities:", nrow(city), "\n")
cat("Number of features:", ncol(city), "\n")

missing_summary <- colSums(is.na(city))
missing_summary[missing_summary > 0]
```

## Numeric variables distribution
```{r}
city_num <- city |> dplyr::select(where(is.numeric))

city_num |>
  tidyr::pivot_longer(cols = everything(), names_to = "variable", values_to = "value") |>
  ggplot(aes(x = value)) +
  geom_histogram(bins = 20, fill = "#2C79B8", alpha = 0.7) +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Distribution of Numeric City Features",
       x = "Value",
       y = "Count")
```

## Correlation matrix of city lifestyle features
```{r}
corr_mat <- cor(city_num, use = "pairwise.complete.obs")

ggcorrplot(corr_mat,
           method = "square",
           type   = "lower",
           lab    = FALSE,
           outline.color = "white",
           show.legend   = TRUE) +
  labs(title = "Correlation Matrix of City Lifestyle Features")
```
*Several meaningful relationships are observed:*

- avg_income and avg_rent show a strong positive correlation, indicating that wealthier cities tend to have higher living costs.
- happiness_score is moderately positively correlated with both income and green_space_ratio, suggesting better wellbeing in greener and richer cities.
- air_quality_index is negatively correlated with green space and income, implying that pollution is more severe in less affluent and less green cities.
- public_transport_score shows a slight positive association with population density, indicating that highly populated cities invest more in transportation infrastructure.

These patterns highlight how economic development, environmental quality, and public services jointly shape the lifestyle structure of cities.

## Population v.s. Happiness score
```{r}
ggplot(city, aes(x = population_density, y = happiness_score)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  theme_minimal() +
  labs(title = "Happiness vs Population Density",
       x = "Population density",
       y = "Happiness score")
```
*Cities with higher population density tend to report lower happiness levels on average.*
- This suggests that overcrowding may reduce quality of life due to factors such as congestion, limited public space, noise, and increased stress.
- However, the considerable vertical spread of points also indicates that happiness is influenced by additional factors beyond density, such as economic resources and environmental quality.


## Air quality v.s. Income
```{r}
ggplot(city,
       aes(x = avg_income,
           y = air_quality_index,
           size = green_space_ratio)) +
  geom_point(alpha = 0.7, color = "#1B7F79") +
  theme_minimal() +
  scale_size_continuous(name = "Green space ratio") +
  labs(title = "Air Quality vs Income (Bubble size = Green Space)",
       x = "Average income",
       y = "Air quality index")
```
**A noticeable downward trend emerges:** higher-income cities generally exhibit lower air quality index values, indicating better air quality (since lower index = less pollution).

In addition, larger bubbles are more frequently observed among cities with higher incomes, suggesting that wealthier cities also tend to feature more green infrastructure.

Combined, these results imply that economic resources enable improved environmental management, including investments in green spaces and pollution control.

## Happiness across different contries
```{r}
ggplot(city, aes(x = country, y = happiness_score, fill = country)) +
  geom_boxplot(alpha = 0.7) +
  theme_minimal() +
  labs(title = "Happiness Score by Country",
       x = "Country",
       y = "Happiness score") +
  theme(legend.position = "none")
```
- Europe and North America show the highest median happiness scores, with relatively small variability, indicating consistently high quality of life in these developed regions.
- Oceania also performs strongly, though sample size appears smaller.
- Asia and South America have moderate happiness levels with wider spreads, suggesting uneven development and quality-of-life disparities within regions.
- Africa exhibits the lowest median happiness score, reflecting challenges related to economic development and social wellbeing.

# Clustering Analysis
## PCA
### Select numeric variables and standardize the data
```{r}
city_num <- city |> dplyr::select(where(is.numeric))
city_scaled <- scale(city_num)
```

### Run PCA
```{r}
pca_res <- prcomp(city_scaled, scale. = FALSE)

pca_var <- pca_res$sdev^2
pca_var_ratio <- pca_var / sum(pca_var)

pca_var_ratio
```

The first principal component accounts for 53.8% of the variance, while the second accounts for an additional 25.8%. Together, PC1 and PC2 explain 79.6% of the total variance.

### Scree Plot of PCA
```{r}
plot(pca_var_ratio,
     xlab = "Principal Component",
     ylab = "Variance Explained",
     main = "Scree Plot of PCA",
     type = "b")
```
Thus, we retain the first 4 components for clustering and visualization to ensure an optimal balance between information preservation and dimensionality reduction.

### PCA Projection (PC1 vs PC2)
```{r}
pca_scores <- as.data.frame(pca_res$x[,1:2])
colnames(pca_scores) <- c("PC1", "PC2")

ggplot(pca_scores, aes(x = PC1, y = PC2)) +
  geom_point(alpha = 0.7, color = "#006699") +
  theme_minimal() +
  labs(title = "Cities in PCA Space",
       x = "PC1", y = "PC2")
```
## K-Means Clustering
### Perform K-means Clustering on first 4 PCs
```{r}
set.seed(42) 

pca_for_cluster <- as.data.frame(pca_res$x[,1:4]) # use the first four components
k3 <- kmeans(pca_for_cluster, centers = 3, nstart = 25)

city$cluster <- factor(k3$cluster)
pca_scores$cluster <- factor(k3$cluster)

table(city$cluster)
```

### Cluster visualization in PCA Space (2D)
```{r}
ggplot(pca_scores, aes(PC1, PC2, color = cluster)) +
  geom_point(alpha = 0.8, size = 3) +
  theme_minimal() +
  labs(title = "City Lifestyle Clusters in PCA Space",
       color = "Cluster")
```
### Cluster visualization in PCA Space (3D)
```{r}
pca_3d <- as.data.frame(pca_res$x[,1:3])
colnames(pca_3d) <- c("PC1", "PC2", "PC3")
pca_3d$cluster <- city$cluster

plot_ly(pca_3d,
        x = ~PC1,
        y = ~PC2,
        z = ~PC3,
        color = ~cluster,
        colors = c("#1B7F79", "#D95F02", "#7570B3"),
        type = "scatter3d",
        mode = "markers",
        marker = list(size = 5, opacity = 0.85)) %>%
  layout(
    title = "3D PCA Clustering of City Lifestyles",
    scene = list(
      xaxis = list(title = "PC1"),
      yaxis = list(title = "PC2"),
      zaxis = list(title = "PC3")
    )
  )
```

### Cluster profile table
```{r}
cluster_profile <- city |>
  group_by(cluster) |>
  summarise(across(where(is.numeric),
                   list(mean = ~mean(.x, na.rm = TRUE),
                        sd = ~sd(.x, na.rm = TRUE)),
                   .names = "{.col}_{.fn}"))

cluster_profile
```

**Cluster Interpretation:**

**Cluster 1 - Affordable but Lower-Quality**

* Moderate population density
* Very low income
* Poor internet access & public transportation
* Lower happiness
* Limited green space
	
**Cluster 2 - High-Quality and Wealthy Cities**

* Lower population density (compared to Cluster 3)
* Highest income and rent
* Strong public transportation
* Highest happiness
* Good green space ratios
	
**Cluster 3 - Urban-Pressure Cities**

* Extremely high population density
* Medium income & internet penetration
* High public transport scores
* Lower air quality
* Lower green space availability

### Create a world map to visualize three clusters
```{r}
world <- ne_countries(scale = "medium", returnclass = "sf")

world_cont <- world |>
  dplyr::group_by(continent) |>
  dplyr::summarise(geometry = sf::st_union(geometry))
```

```{r}
region_cluster <- city |>
  dplyr::count(country, cluster) |>
  dplyr::group_by(country) |>
  dplyr::slice_max(n, n = 1, with_ties = FALSE)

region_cluster
```

```{r}
map_data <- world_cont |>
  dplyr::left_join(region_cluster,
                   by = c("continent" = "country"))

ggplot(map_data) +
  geom_sf(aes(fill = cluster), color = "white") +
  scale_fill_brewer(palette = "Set2", na.value = "grey90") +
  theme_minimal() +
  labs(title = "Dominant City Lifestyle Cluster by World Region",
       fill  = "Cluster")
```

